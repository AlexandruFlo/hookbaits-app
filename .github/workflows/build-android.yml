name: Android Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.22.2'

      - name: Create Flutter project
        run: |
          flutter create mobile_app --org com.hookbaits --project-name hookbaits_shop --platforms=android
          cd mobile_app
          flutter pub add http webview_flutter provider

      - name: Create app files
        working-directory: mobile_app
        run: |
          mkdir -p lib/screens
          echo 'import "package:flutter/material.dart";' > lib/main.dart
          echo 'import "screens/product_list.dart";' >> lib/main.dart
          echo 'void main() => runApp(MaterialApp(home: ProductListScreen(), title: "Hookbaits"));' >> lib/main.dart

      - name: Create config
        working-directory: mobile_app
        run: |
          echo 'class Config {' > lib/config.dart
          echo '  static const String baseUrl = "https://hookbaits.ro";' >> lib/config.dart
          echo '}' >> lib/config.dart

      - name: Create product screen
        working-directory: mobile_app
        run: |
          echo 'import "package:flutter/material.dart";' > lib/screens/product_list.dart
          echo 'import "package:http/http.dart" as http;' >> lib/screens/product_list.dart
          echo 'import "dart:convert";' >> lib/screens/product_list.dart
          echo 'import "../config.dart";' >> lib/screens/product_list.dart

      - name: Add product screen class
        working-directory: mobile_app
        run: |
          echo 'class ProductListScreen extends StatefulWidget {' >> lib/screens/product_list.dart
          echo '  createState() => _ProductListScreenState();' >> lib/screens/product_list.dart
          echo '}' >> lib/screens/product_list.dart

      - name: Add state class
        working-directory: mobile_app
        run: |
          echo 'class _ProductListScreenState extends State<ProductListScreen> {' >> lib/screens/product_list.dart
          echo '  List products = [];' >> lib/screens/product_list.dart
          echo '  bool loading = true;' >> lib/screens/product_list.dart

      - name: Add init method
        working-directory: mobile_app
        run: |
          echo '  initState() {' >> lib/screens/product_list.dart
          echo '    super.initState();' >> lib/screens/product_list.dart
          echo '    loadProducts();' >> lib/screens/product_list.dart
          echo '  }' >> lib/screens/product_list.dart

      - name: Add load products method
        working-directory: mobile_app
        run: |
          echo '  loadProducts() async {' >> lib/screens/product_list.dart
          echo '    try {' >> lib/screens/product_list.dart
          echo '      final response = await http.get(Uri.parse("${Config.baseUrl}/wp-json/wc/v3/products"));' >> lib/screens/product_list.dart
          echo '      if (response.statusCode == 200) {' >> lib/screens/product_list.dart
          echo '        setState(() {' >> lib/screens/product_list.dart
          echo '          products = json.decode(response.body);' >> lib/screens/product_list.dart
          echo '          loading = false;' >> lib/screens/product_list.dart
          echo '        });' >> lib/screens/product_list.dart
          echo '      }' >> lib/screens/product_list.dart
          echo '    } catch (e) {' >> lib/screens/product_list.dart
          echo '      setState(() => loading = false);' >> lib/screens/product_list.dart
          echo '    }' >> lib/screens/product_list.dart
          echo '  }' >> lib/screens/product_list.dart

      - name: Add build method start
        working-directory: mobile_app
        run: |
          echo '  Widget build(context) {' >> lib/screens/product_list.dart
          echo '    return Scaffold(' >> lib/screens/product_list.dart
          echo '      appBar: AppBar(title: Text("Hookbaits")),' >> lib/screens/product_list.dart
          echo '      body: loading' >> lib/screens/product_list.dart
          echo '        ? Center(child: CircularProgressIndicator())' >> lib/screens/product_list.dart
          echo '        : ListView.builder(' >> lib/screens/product_list.dart
          echo '            itemCount: products.length,' >> lib/screens/product_list.dart
          echo '            itemBuilder: (context, index) {' >> lib/screens/product_list.dart

      - name: Add item builder
        working-directory: mobile_app
        run: |
          echo '              final product = products[index];' >> lib/screens/product_list.dart
          echo '              return Card(' >> lib/screens/product_list.dart
          echo '                margin: EdgeInsets.all(8),' >> lib/screens/product_list.dart
          echo '                child: ListTile(' >> lib/screens/product_list.dart
          echo '                  leading: product["images"] != null && product["images"].isNotEmpty' >> lib/screens/product_list.dart
          echo '                    ? Image.network(product["images"][0]["src"], width: 50, height: 50, fit: BoxFit.cover)' >> lib/screens/product_list.dart
          echo '                    : Icon(Icons.image),' >> lib/screens/product_list.dart

      - name: Add product details
        working-directory: mobile_app
        run: |
          echo '                  title: Text(product["name"] ?? "Produs"),' >> lib/screens/product_list.dart
          echo '                  subtitle: Text("${product["price"] ?? "0"} RON"),' >> lib/screens/product_list.dart
          echo '                  trailing: ElevatedButton(' >> lib/screens/product_list.dart
          echo '                    onPressed: () {' >> lib/screens/product_list.dart
          echo '                      ScaffoldMessenger.of(context).showSnackBar(' >> lib/screens/product_list.dart
          echo '                        SnackBar(content: Text("Produs adăugat"))' >> lib/screens/product_list.dart
          echo '                      );' >> lib/screens/product_list.dart
          echo '                    },' >> lib/screens/product_list.dart
          echo '                    child: Text("Adaugă"),' >> lib/screens/product_list.dart
          echo '                  ),' >> lib/screens/product_list.dart

      - name: Close widgets
        working-directory: mobile_app
        run: |
          echo '                ),' >> lib/screens/product_list.dart
          echo '              );' >> lib/screens/product_list.dart
          echo '            },' >> lib/screens/product_list.dart
          echo '          ),' >> lib/screens/product_list.dart
          echo '    );' >> lib/screens/product_list.dart
          echo '  }' >> lib/screens/product_list.dart
          echo '}' >> lib/screens/product_list.dart

      - name: Configure Android
        working-directory: mobile_app
        run: |
          if [ -f android/app/build.gradle ]; then
            sed -i "s/minSdkVersion [0-9]\+/minSdkVersion 21/" android/app/build.gradle
            sed -i "s/compileSdkVersion [0-9]\+/compileSdkVersion 34/" android/app/build.gradle
            sed -i "s/targetSdkVersion [0-9]\+/targetSdkVersion 34/" android/app/build.gradle
          fi

      - name: Build APK
        working-directory: mobile_app
        run: flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: hookbaits-apk
          path: mobile_app/build/app/outputs/**/*.apk


